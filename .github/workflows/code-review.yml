name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches:
      - main-review

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Get PR diff
        run: |
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- '*.java' > /tmp/pr_diff.txt

      - name: Run AI Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude --model claude-sonnet-4-5-20250929 --max-turns 10 --print \
            "당신은 코드 리뷰어입니다.

          [지시사항]
          1. code_review_guide.md를 읽고 리뷰 기준을 파악하세요.
          2. 아래 PR diff와 변경된 파일의 전체 내용을 분석하세요.
          3. 반드시 아래 JSON 형식으로만 응답하세요. JSON 외 텍스트는 절대 포함하지 마세요.
          4. line은 변경된 파일의 실제 라인 번호입니다.

          [응답 형식 - 이 JSON만 출력하세요]
          {
            \"comments\": [
              {\"path\": \"파일경로\", \"line\": 라인번호, \"body\": \"리뷰 코멘트\"}
            ],
            \"summary\": \"전체 요약 (code_review_guide.md 형식)\"
          }

          === PR DIFF ===
          $(cat /tmp/pr_diff.txt)
          === END DIFF ===" > /tmp/review_raw.txt

          # Python으로 안정적으로 JSON 추출
          python3 -c "
          import json, re, sys
          raw = open('/tmp/review_raw.txt').read()
          # ```json ... ``` 블록 추출 시도
          m = re.search(r'\`\`\`json\s*(.*?)\`\`\`', raw, re.DOTALL)
          if not m:
              m = re.search(r'\`\`\`\s*(.*?)\`\`\`', raw, re.DOTALL)
          if m:
              text = m.group(1)
          else:
              text = raw
          # 첫 번째 { 부터 마지막 } 까지 추출
          start = text.find('{')
          end = text.rfind('}')
          if start == -1 or end == -1:
              print('ERROR: No JSON found', file=sys.stderr)
              sys.exit(1)
          json_str = text[start:end+1]
          data = json.loads(json_str)
          json.dump(data, open('/tmp/review.json','w'), ensure_ascii=False)
          print('JSON extracted successfully')
          "

          echo "=== Extracted JSON ==="
          cat /tmp/review.json

      - name: Post inline review comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          COMMIT_SHA=${{ github.event.pull_request.head.sha }}
          REPO=${{ github.repository }}

          # summary 추출
          SUMMARY=$(jq -r '.summary' /tmp/review.json)

          # comments 배열을 GitHub API 형식으로 변환
          COMMENTS=$(jq -c '[.comments[] | {path: .path, line: .line, body: .body}]' /tmp/review.json)

          # PR review 생성 (인라인 코멘트 + 요약)
          jq -n \
            --arg commit_id "$COMMIT_SHA" \
            --arg body "$SUMMARY" \
            --argjson comments "$COMMENTS" \
            '{
              commit_id: $commit_id,
              body: $body,
              event: "COMMENT",
              comments: $comments
            }' | gh api "repos/${REPO}/pulls/${PR_NUMBER}/reviews" \
              --input - \
              --method POST

          echo "Review posted successfully!"
