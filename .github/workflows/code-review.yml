name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches:
      - main-review

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Get PR diff
        run: |
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- '*.java' > /tmp/pr_diff.txt

      - name: Run AI Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          claude --model claude-sonnet-4-5-20250929 --max-turns 10 --print \
            "당신은 코드 리뷰어입니다.

          [지시사항]
          1. code_review_guide.md를 읽고 리뷰 기준을 파악하세요.
          2. 아래 PR diff와 변경된 파일의 전체 내용을 분석하세요.
          3. 반드시 아래 JSON 형식으로만 응답하세요. JSON 외 텍스트는 절대 포함하지 마세요.
          4. line은 변경된 파일의 실제 라인 번호입니다.

          [응답 형식 - 이 JSON만 출력하세요]
          {
            \"comments\": [
              {\"path\": \"파일경로\", \"line\": 라인번호, \"body\": \"리뷰 코멘트\"}
            ],
            \"summary\": \"전체 요약 (code_review_guide.md 형식)\"
          }

          === PR DIFF ===
          $(cat /tmp/pr_diff.txt)
          === END DIFF ===" > /tmp/review_raw.txt

          # JSON 블록 추출 (```json ... ``` 또는 순수 JSON)
          if grep -q '```json' /tmp/review_raw.txt; then
            sed -n '/```json/,/```/p' /tmp/review_raw.txt | sed '1d;$d' > /tmp/review.json
          elif grep -q '```' /tmp/review_raw.txt; then
            sed -n '/```/,/```/p' /tmp/review_raw.txt | sed '1d;$d' > /tmp/review.json
          else
            # 첫 번째 { 부터 마지막 } 까지 추출
            sed -n '/^{/,/^}/p' /tmp/review_raw.txt > /tmp/review.json
          fi

          echo "=== Extracted JSON ==="
          cat /tmp/review.json

      - name: Post inline review comments
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          COMMIT_SHA=${{ github.event.pull_request.head.sha }}
          REPO=${{ github.repository }}

          # summary 추출
          SUMMARY=$(jq -r '.summary' /tmp/review.json)

          # comments 배열을 GitHub API 형식으로 변환
          COMMENTS=$(jq -c '[.comments[] | {path: .path, line: .line, body: .body}]' /tmp/review.json)

          # PR review 생성 (인라인 코멘트 + 요약)
          jq -n \
            --arg commit_id "$COMMIT_SHA" \
            --arg body "$SUMMARY" \
            --argjson comments "$COMMENTS" \
            '{
              commit_id: $commit_id,
              body: $body,
              event: "COMMENT",
              comments: $comments
            }' | gh api "repos/${REPO}/pulls/${PR_NUMBER}/reviews" \
              --input - \
              --method POST

          echo "Review posted successfully!"
