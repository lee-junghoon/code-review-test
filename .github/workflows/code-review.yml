name: AI Code Review

on:
  pull_request:
    types: [opened, synchronize, ready_for_review]
    branches:
      - main-review

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  code-review:
    if: github.event.pull_request.draft == false
    runs-on: ubuntu-latest
    timeout-minutes: 15

    steps:
      - name: Generate App Token
        id: app-token
        uses: actions/create-github-app-token@v1
        with:
          app-id: ${{ secrets.CODE_REVIEW_APP_ID }}
          private-key: ${{ secrets.CODE_REVIEW_APP_PRIVATE_KEY }}

      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Claude Code
        run: npm install -g @anthropic-ai/claude-code

      - name: Get PR diff
        run: |
          git diff origin/${{ github.event.pull_request.base.ref }}...HEAD -- '*.java' > /tmp/pr_diff.txt

      - name: Run AI Code Review
        env:
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
        run: |
          PR_DIFF=$(cat /tmp/pr_diff.txt)
          claude --model claude-sonnet-4-5-20250929 --max-turns 10 --print \
            "당신은 코드 리뷰어입니다.

          [지시사항]
          1. code_review_guide.md를 읽고 리뷰 기준을 파악하세요.
          2. 아래 PR diff와 변경된 파일의 전체 내용을 분석하세요.
          3. 반드시 아래 JSON 형식으로만 응답하세요. JSON 외 텍스트는 절대 포함하지 마세요.
          4. line은 변경된 파일의 실제 라인 번호입니다.

          [응답 형식 - 이 JSON만 출력하세요]
          {
            \"comments\": [
              {\"path\": \"파일경로\", \"line\": 라인번호, \"body\": \"리뷰 코멘트\"}
            ],
            \"summary\": \"전체 요약 (code_review_guide.md 형식)\"
          }

          === PR DIFF ===
          ${PR_DIFF}
          === END DIFF ===" > /tmp/review_raw.txt

          echo "=== Raw output ==="
          head -5 /tmp/review_raw.txt

          python3 .github/scripts/extract_json.py

          echo "=== Extracted JSON ==="
          cat /tmp/review.json

      - name: Post inline review comments
        env:
          GH_TOKEN: ${{ steps.app-token.outputs.token }}
        run: |
          PR_NUMBER=${{ github.event.pull_request.number }}
          COMMIT_SHA=${{ github.event.pull_request.head.sha }}
          REPO=${{ github.repository }}

          SUMMARY=$(jq -r '.summary' /tmp/review.json)
          COMMENTS=$(jq -c '[.comments[] | {path: .path, line: .line, body: .body}]' /tmp/review.json)

          jq -n \
            --arg commit_id "$COMMIT_SHA" \
            --arg body "$SUMMARY" \
            --argjson comments "$COMMENTS" \
            '{
              commit_id: $commit_id,
              body: $body,
              event: "COMMENT",
              comments: $comments
            }' | gh api "repos/${REPO}/pulls/${PR_NUMBER}/reviews" \
              --input - \
              --method POST

          echo "Review posted successfully!"
